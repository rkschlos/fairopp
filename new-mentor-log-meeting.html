<!-- 
Why does this need to be a custom code block?
Mentors are able to have multiple mentees, and
here we need to make sure that mentors have the
ability to ensure which mentee they are recording
a meeting for. Softr does not allow you to have
a dynamic dropdown option (even in custom forms)
-->
<div class="form-container">
  <h2>Enter Call Information</h2>
  <p>
  After scheduling a call with your mentor via Google Cal, please record information about the call below.

  </p>
  <form>
    <div class="form-group">
      <label for="mentees">Select Mentee:</label>
      <select id="mentees" name="mentees" required>
      </select>
    </div>
    <div class="form-group">
      <label for="date">Date of Call:</label>
      <input type="date" id="date" name="date" required>
    </div>
    <div class="form-group">
      <label for="time">Time of Call:</label>
      <input type="time" id="time" name="time" required>
    </div>
    <div class="form-group">
      <label for="call-type">Call Type:</label>
      <select id="call-type" name="call-type" required>
        <option value="Pre-Mentoring Questionnaire">Pre-Mentoring Questionnaire</option>
        <option value="Connecting">Connecting</option>
        <option value="Creating a College List">Creating a College List</option>
        <option value="College Application Timeline">College Application Timeline</option>
        <option value="Standardized Tests">Standardized Tests</option>
        <option value="College Essays">College Essays</option>
        <option value="Letters of Recommendation">Letters of Recommendation</option>
        <option value="Financial Aid/Scholarships">Financial Aid/Scholarships</option>
        <option value="Interviews & Post-Submission">Interviews & Post-Submission</option>
        <option value="Preparation for College Life">Preparation for College Life</option>
        <option value="Making a College Decision">Making a College Decision</option>
        <option value="Post-Mentoring Questionnaire">Post-Mentoring Questionnaire</option>
      </select>
    </div>
    <div class="form-group">
      <label for="session-activities">Session Activities:</label>
      <input type="text-area" id="session-activities" name="session-activities" required>
    </div>
    <div class="form-group">
      <label for="homework-assigned">Homework Assigned:</label>
      <input type="text-area" id="homework-assigned" name="homework-assigned" required>
    </div>
    
    <button type="submit" onclick="submitForm()">Submit</button>
  </form>
</div>
<style>

p {font-family: Poppins;}

.form-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
}

input[type="date"], input[type="time"], select {
  display: block;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 16px;
  width: 100%;
  box-sizing: border-box;
}

button[type="submit"] {
  display: block;
  padding: 10px 20px;
  background-color: #2BB99D;
  color: #fff;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
}

button[type="submit"]:hover {
  background-color: #3e8e41;
}

</style>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/gh/justKD/AirpuckJS@master/airpuck.min.js"></script>
<script>

async function getMentees() {
    return new Promise(function(resolve, reject) {
        const table = new Airpuck.Table({
            name: "Mentorships",
            baseID: BASE_ID,
            apiKey: API_KEY
        }, _ => {
            const rows = table.getRecordsByField("Mentor Email", window.logged_in_user["Email"]);
            const result = rows.map((row) => {
                return {
                    email: row.fields["Mentee Email"][0],
                    name: row.fields["Mentee First Name"] + " " + row.fields["Mentee Last Name"],
                    id: row.fields["Mentee"],
                }
            });
            resolve(result);
        });
    });
}

function setMentees(data) {
    const menteeSelect = document.getElementById('mentees');
    menteeSelect.innerHTML = '';
    // Add the new mentor options to the select element
    data.forEach(mentee => {
      const option = document.createElement('option');
      option.value = mentee.id;
      option.text = mentee.name;
      menteeSelect.appendChild(option);
    });
}

async function initializeDropdown() {
    const mentees = await getMentees();
    setMentees(mentees);
}
document.addEventListener('DOMContentLoaded', initializeDropdown);

async function getUserId(usr) {
    return new Promise((resolve, reject) => {
        const usersTable = new Airpuck.Table({
        name: "Users",
        baseID: "appKUVt8K5fU6BOOJ",
        apiKey: "pat8hGmchfWiq8HXf.14a1ab90542639e1741aa223517937a0f5edda7ea54e82700193a2b65aa7ce27"
        }, _ => {
            const user = usersTable.getRecordsByField("Email", usr)[0];
            resolve(user.id);
        });
    });
}

function getUserTimezone() {
    // Get the user's time zone offset
    const timezoneOffset = new Date().getTimezoneOffset();

    // Convert the offset to hours
    const timezoneOffsetHours = timezoneOffset / 60;

    // Get the user's time zone
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    
    return timezone;
}




function getISOstring(date, time, timezone) {
  const dateTimeString = `${date}T${time}:00.000`;
  const dateTime = new Date(dateTimeString);
  const isoDateTime = dateTime.toLocaleString('en-US', { timeZone: timezone, timeZoneName: 'short' });
  return isoDateTime;
}


async function submitForm() {
    // Get the form values
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    console.log(time)
    const mentee = document.getElementById("mentees").value;
    const timezone = getUserTimezone();
    const isoDateTime = getISOstring(date, time, timezone);
    const callType = document.getElementById("call-type").value;
    const sessionActivities = document.getElementById("session-activities").value;
    const homeworkAssigned = document.getElementById("homework-assigned").value;
    
    
    
    
    const callsTable = new Airpuck.Table({
        name: "Mentorship Calls",
        baseID: "appKUVt8K5fU6BOOJ",
        apiKey: "pat8hGmchfWiq8HXf.14a1ab90542639e1741aa223517937a0f5edda7ea54e82700193a2b65aa7ce27"
    }, _ => {
        const record = new callsTable.record();
        record.fields = {};
        record.fields["Mentor"] = [window.logged_in_user.airtable_record_id];
        record.fields["Mentee"] = [mentee];
        record.fields["Call Time"] = isoDateTime;
        record.fields["Initial call type"] = callType;
        record.fields["Session Activities"] = sessionActivities;
        record.fields["Homework Assigned"] = homeworkAssigned;
        
        record.fields["Timezone"] = timezone;
        callsTable.add(record, () => {
            window.location = "mentor-calls";
        }, (e) => {});
    });
    
}

</script>



    