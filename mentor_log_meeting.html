<!-- 
Why does this need to be a custom code block?
Mentors are able to have multiple mentees, and
here we need to make sure that mentors have the
ability to ensure which mentee they are recording
a meeting for. Softr does not allow you to have
a dynamic dropdown option (even in custom forms)
-->
<div class="form-container">
  <h2>Enter Call Information</h2>
  <p>
  Use this form to record a past or upcoming call with one of your mentees. This helps us help you stay on track with your mentees progress and check-in along the way.
  </p>
  <form>
    <div class="form-group">
      <label for="mentees">Select Mentee:</label>
      <select id="mentees" name="mentees" required>
      </select>
    </div>
    <div class="form-group">
      <label for="date">Date of Call:</label>
      <input type="date" id="date" name="date" required>
    </div>
    <div class="form-group">
      <label for="time">Time of Call:</label>
      <input type="time" id="time" name="time" required>
    </div>
    <div class="form-group">
      <label for="timezone">Time Zone:</label>
      <input type="datetime-local" id="timezone" name="timezone" required>
    </div>
    <button type="submit" onclick="submitForm()">Submit</button>
  </form>
</div>
<style>

p {font-family: Poppins;}

.form-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
}

input[type="date"], input[type="time"], select {
  display: block;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  font-size: 16px;
  width: 100%;
  box-sizing: border-box;
}

button[type="submit"] {
  display: block;
  padding: 10px 20px;
  background-color: #2BB99D;
  color: #fff;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
}

button[type="submit"]:hover {
  background-color: #3e8e41;
}

</style>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/gh/justKD/AirpuckJS@master/airpuck.min.js"></script>
<script>

async function getMentees() {
    return new Promise(function(resolve, reject) {
        const table = new Airpuck.Table({
            name: "Mentorships",
            baseID: BASE_ID,
            apiKey: API_KEY
        }, _ => {
            const rows = table.getRecordsByField("Mentor Email", window.logged_in_user["Email"]);
            const result = rows.map((row) => {
                return {
                    email: row.fields["Mentee Email"][0],
                    name: row.fields["Mentee First Name"] + " " + row.fields["Mentee Last Name"],
                    id: row.fields["Mentee"],
                }
            });
            resolve(result);
        });
    });
}

function setMentees(data) {
    const menteeSelect = document.getElementById('mentees');
    menteeSelect.innerHTML = '';
    // Add the new mentor options to the select element
    data.forEach(mentee => {
      const option = document.createElement('option');
      option.value = mentee.id;
      option.text = mentee.name;
      menteeSelect.appendChild(option);
    });
}

async function initializeDropdown() {
    const mentees = await getMentees();
    setMentees(mentees);
}
document.addEventListener('DOMContentLoaded', initializeDropdown);

async function getUserId(usr) {
    return new Promise((resolve, reject) => {
        const usersTable = new Airpuck.Table({
        name: "Users",
        baseID: "appKUVt8K5fU6BOOJ",
        apiKey: "pat8hGmchfWiq8HXf.14a1ab90542639e1741aa223517937a0f5edda7ea54e82700193a2b65aa7ce27"
        }, _ => {
            const user = usersTable.getRecordsByField("Email", usr)[0];
            resolve(user.id);
        });
    });
}

async function submitForm() {
    // Get the form values
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const mentee = document.getElementById("mentees").value;
    
    const callsTable = new Airpuck.Table({
        name: "Mentorship Calls",
        baseID: "appKUVt8K5fU6BOOJ",
        apiKey: "pat8hGmchfWiq8HXf.14a1ab90542639e1741aa223517937a0f5edda7ea54e82700193a2b65aa7ce27"
    }, _ => {
        const record = new callsTable.record();
        record.fields = {};
        record.fields["Mentor"] = [window.logged_in_user.airtable_record_id];
        record.fields["Mentee"] = [mentee];
        record.fields["Call Time"] = date + " " + time;
        callsTable.add(record, () => {
            window.location = "mentor-calls";
        }, (e) => {});
    });
    
}

</script>